version: 1
defaultRefs: [master]

tasks:
  - name: tidb-cyclo
    taskType: cyclo
    shellScript: |
      gocyclo -over 20 -avg -ignore "_test|pb.go" ./ | tee repo_cyclo.log

  - name: tidb-build
    taskType: build
    shellScript: |
      make
    outputDir: bin/
    buildEnv:
      image: hub.pingcap.net/jenkins/centos7_golang-1.16:latest
      
  - name: tidb-ut
    taskType: atom-ut-codecov
    shellScript: |
      export log_level=warn
      mkdir -p coverage_report
      make br_unit_test_in_verify_ci
      mv test_coverage/br_cov.unit_test.out coverage_report/br.coverage
      make dumpling_unit_test_in_verify_ci
      mv test_coverage/dumpling_cov.unit_test.out coverage_report/dumpling.coverage
      make gotest_in_verify_ci
      mv test_coverage/tidb_cov.unit_test.out coverage_report/tidb.coverage
    buildEnv:
      image: hub.pingcap.net/jenkins/centos7_golang-1.16:latest
    utReportDir: test_report
    covReportDir: coverage_report
    coverageRate: 50
      
      
notify:
  lark: []
  email: [kevinsocial@outlook.com]
